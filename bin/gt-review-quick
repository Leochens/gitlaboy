#!/usr/bin/env node

const Gitlab = require('@gitbeaker/rest').Gitlab;


const getConfig = require('../utils/getConfig');

const checkRoot = require('../utils/checkRoot');
if (!checkRoot()) { return }
const chalk = require('chalk');
const inquirer = require('inquirer');
const { getMergeRequests, mergeMr } = require('../utils');
const review = async () => {
    const config = getConfig();
    const quickReviewUser = config.baseConfig['quick-review-user'] || ''
    if (!quickReviewUser) return console.log(chalk.red('è¿˜æœªé…ç½®æé€Ÿå®¡æ ¸äººï¼Œè¯·å…ˆä½¿ç”¨gt-configè¿›è¡Œé…ç½®åå†è¯•ï¼'));
    const userConfig = config.userConfig || {}
    const quickReviewUserToken = userConfig[quickReviewUser];
    if (!quickReviewUserToken) return console.log(chalk.red('æé€Ÿå®¡æ ¸äººçš„Tokenä¸èƒ½ä¸ºç©ºï¼Œè¯·é‡æ–°æ·»åŠ ç”¨æˆ·å¹¶è®¾ç½®æé€Ÿå®¡æ ¸äººåå†è¯•ï¼'));
    // è¯·æ±‚æŒ‡å®šå®¡æ ¸äººçš„mr
    const mrs = await getMergeRequests({ assigneeName: quickReviewUser });

    console.log(chalk.green(`ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€å½“å‰å¤„äºæé€Ÿå®¡æ ¸æµç¨‹ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€`));
    console.log(chalk.green(`ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€æ³¨æ„,æ­¤å‘½ä»¤ä»…åœ¨å®¡æ ¸äººä¸æ–¹ä¾¿å¹¶ä¸”ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨!æ™®é€šMRè¯·èµ°æ­£å¸¸å®¡æ ¸æµç¨‹!ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€`));
    console.log(chalk.green(`ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€å› æœªé€šçŸ¥å®¡æ ¸äººè€Œåˆå¹¶çš„MRå‡ºçš„é£é™©äº‹æ•…ï¼Œæ“ä½œäººè´Ÿè´£!ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€`));
    console.log(chalk.green(`ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥è¯·ç¡®è®¤åæ“ä½œï¼       ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥`));
    console.log(chalk.green(`å®¡æ ¸äººã€${quickReviewUser}ã€‘çš„å¯¹äºå½“å‰ç”¨æˆ·ã€${config.baseConfig['gitUser-name']}ã€‘å¾…å®¡æ ¸mr: `));
    if (!mrs?.length) {
        return console.log(chalk.red('æš‚æ— mrå®¡æ ¸'))
    }
    const statusMap = {
        can_be_merged: 'å…è®¸åˆå¹¶âœ…',
        unchecked: 'è¿˜æœªæ£€æŸ¥â³è¯·ç¨åå†è¯•',
        checking: 'æ£€æŸ¥ä¸­â³è¯·ç¨åå†è¯•',
        cannot_be_merged: 'å†²çªå¼‚å¸¸âŒ',
        cannot_be_merged_recheck: 'é‡å¤æ£€æŸ¥å¤±è´¥âŒ'
    }
    const res = await inquirer
        .prompt([{
            type: 'checkbox',
            name: 'mrs',
            message: `å¤šé€‰å®¡æ ¸é€šè¿‡`,
            choices: mrs.map((mr) => {
                const stats = mr.lineStats ? ` | å˜æ›´ï¼š+${mr.lineStats.additions} -${mr.lineStats.deletions} (å…±${mr.lineStats.total})` : '';
                return ({ value: mr, name: `${statusMap[mr.merge_status]} ${stats} [${mr.iid}] ${mr.title} | ${mr.source_branch} => ${mr.target_branch} ğŸ‘¨â€ğŸ’»â€${mr.author.name} å®¡æ ¸é“¾æ¥ä¸º: ${mr.web_url}` })
            })
        }
        ])
    const selectedMrs = res.mrs;
    for (let mr of selectedMrs) {
        if (mr.merge_status !== 'can_be_merged') {
            console.log(chalk.red(`[${mr.iid}]åˆå¹¶å¤±è´¥ï¼ å½“å‰çŠ¶æ€ä¸º: ${statusMap[mr.merge_status]}`));
            continue
        }
        console.log(chalk.yellow(`å¼€å§‹åˆå¹¶ [${mr.iid}]...`));
        const mrRes = await mergeMr({
            projectId: mr.project_id, mergerequestIId: mr.iid, customApi: new Gitlab({
                host: config.baseConfig['gitUser-url'],
                token: quickReviewUserToken,
            })
        })
        // console.log(mrRes);
        if (mrRes.state === 'merged') {
            console.log(chalk.green(`åˆå¹¶ [${mr.iid}] ${mr.title} æˆåŠŸï¼æé€Ÿå®¡æ ¸äººä¸º ${quickReviewUser}`));
        } else {
            console.log(chalk.red(`æœªèƒ½æ­£å¸¸åˆå¹¶ [${mr.iid}] ${mr.title} ${mr.web_url}`));
        }
    }
}
review()